<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K16: Random Loser</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            overflow: hidden; font-family: 'Arial Black', sans-serif;
            background-color: #111; color: #fff; touch-action: none; user-select: none;
            display: flex; justify-content: center; align-items: center;
        }

        canvas {
            display: block; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;
        }

        /* 텍스트 UI 레이어 */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            pointer-events: none; z-index: 10;
        }

        #instruction {
            font-size: 2rem; color: rgba(255, 255, 255, 0.5); text-align: center;
            text-transform: uppercase; letter-spacing: 2px;
            transition: opacity 0.3s;
        }

        #countdown {
            font-size: 8rem; font-weight: 900; color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            opacity: 0; transition: transform 0.1s;
        }

        .pulse { animation: pulseAnim 1s infinite alternate; }
        @keyframes pulseAnim { 0% { transform: scale(0.95); opacity: 0.5; } 100% { transform: scale(1.05); opacity: 1; } }

        /* 결과 화면 흔들림 */
        .shake { animation: shakeAnim 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeAnim {
            0%, 100% { transform: translate3d(0, 0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate3d(-15px, 15px, 0); }
            20%, 40%, 60%, 80% { transform: translate3d(15px, -15px, 0); }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="instruction" class="pulse">PLACE YOUR<br>FINGERS</div>
        <div id="countdown">3</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const instruction = document.getElementById('instruction');
        const countdownEl = document.getElementById('countdown');

        let width, height;
        let gameState = 'WAITING'; // WAITING, COUNTDOWN, RESULT
        
        // 터치 관리
        const activeTouches = new Map();
        // 파티에 어울리는 강렬하고 다채로운 네온 컬러들
        const colorPalette = ['#FF3366', '#33CCFF', '#33FF66', '#FFCC00', '#CC33FF', '#FF6600', '#00FFFF', '#FF00FF'];
        let availableColors = [...colorPalette];

        // 타이머 및 애니메이션 변수
        let countdownStart = 0;
        let countdownValue = 3;
        let lastTick = 3;
        let frame = 0;
        
        // 파티클 시스템
        let particles = [];
        let explosionCircle = { radius: 0, maxRadius: 0, x: 0, y: 0, color: '', active: false };

        // --- 오디오 시스템 (Web Audio API) ---
        let audioCtx;
        function initAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(type) {
            if(!audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if(type === 'touchOn') {
                // 손가락 올릴 때: 뾱! (음이 올라감)
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if(type === 'touchOff') {
                // 손가락 뗄 때: 뽁. (음이 내려감)
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(200, now + 0.1);
                gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if(type === 'tick') {
                // 카운트다운 틱
                osc.type = 'square'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.05);
                gain.gain.setValueAtTime(0.4, now); gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            } else if(type === 'boom') {
                // 당첨자 폭발음 (화이트 노이즈 굉음)
                const bufferSize = audioCtx.sampleRate * 1.5;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
                const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass';
                filter.frequency.setValueAtTime(2000, now); filter.frequency.exponentialRampToValueAtTime(100, now + 1.0);
                
                gain.gain.setValueAtTime(1.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
                noise.start(now);
            }
        }

        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            explosionCircle.maxRadius = Math.hypot(width, height); // 화면을 덮기 위한 최대 반지름
        }
        window.addEventListener('resize', resize);
        resize();

        // 파티클 생성기
        function createExplosion(x, y, color) {
            explosionCircle = { x, y, radius: 10, maxRadius: Math.hypot(width, height) + 100, color: color, active: true };
            particles = [];
            for(let i=0; i<150; i++) {
                let angle = Math.random() * Math.PI * 2;
                let speed = Math.random() * 20 + 5;
                particles.push({
                    x: x, y: y,
                    vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
                    radius: Math.random() * 15 + 5,
                    color: color,
                    alpha: 1, decay: Math.random() * 0.02 + 0.01
                });
            }
        }

        // --- 입력(터치) 처리 로직 ---
        function handleTouchStart(e) {
            e.preventDefault(); initAudio();
            if (gameState === 'RESULT') return; // 결과 화면에서는 무시 (리셋은 touchend에서)

            for (let i = 0; i < e.changedTouches.length; i++) {
                let touch = e.changedTouches[i];
                if (!activeTouches.has(touch.identifier) && availableColors.length > 0) {
                    // 랜덤 컬러 배정
                    let colorIndex = Math.floor(Math.random() * availableColors.length);
                    let color = availableColors.splice(colorIndex, 1)[0];
                    
                    activeTouches.set(touch.identifier, { x: touch.clientX, y: touch.clientY, color: color, pulse: 0 });
                    playSound('touchOn');
                    if(navigator.vibrate) navigator.vibrate(30); // 손가락 올릴 때 짧은 진동
                }
            }
            checkGameState();
        }

        function handleTouchMove(e) {
            e.preventDefault();
            for (let i = 0; i < e.changedTouches.length; i++) {
                let touch = e.changedTouches[i];
                if (activeTouches.has(touch.identifier)) {
                    let touchData = activeTouches.get(touch.identifier);
                    touchData.x = touch.clientX; touchData.y = touch.clientY;
                }
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            
            // 결과 화면에서 화면에서 손을 떼면 게임 리셋
            if (gameState === 'RESULT') {
                if(e.touches.length === 0) resetGame();
                return;
            }

            for (let i = 0; i < e.changedTouches.length; i++) {
                let touch = e.changedTouches[i];
                if (activeTouches.has(touch.identifier)) {
                    let color = activeTouches.get(touch.identifier).color;
                    availableColors.push(color); // 색상 반환
                    activeTouches.delete(touch.identifier);
                    playSound('touchOff');
                    if(navigator.vibrate) navigator.vibrate(20); // 뗄 때 얕은 진동
                }
            }
            checkGameState();
        }

        canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
        canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
        canvas.addEventListener('touchend', handleTouchEnd, {passive: false});
        canvas.addEventListener('touchcancel', handleTouchEnd, {passive: false});

        // 상태 체크 및 3초 카운트다운 시작/리셋
        function checkGameState() {
            if (gameState === 'RESULT') return;

            if (activeTouches.size >= 2) {
                // 2명 이상이면 카운트다운 시작/재시작
                gameState = 'COUNTDOWN';
                countdownStart = Date.now();
                lastTick = 3;
                instruction.style.opacity = '0';
                countdownEl.style.opacity = '1';
                countdownEl.innerText = '3';
                playSound('tick');
                if(navigator.vibrate) navigator.vibrate(50);
            } else {
                // 1명 이하면 카운트다운 취소
                gameState = 'WAITING';
                instruction.style.opacity = '1';
                countdownEl.style.opacity = '0';
            }
        }

        // 결과 (당첨자) 처리
        function triggerResult() {
            gameState = 'RESULT';
            countdownEl.style.opacity = '0';
            
            // 활성화된 터치 중 랜덤으로 한 명 선택
            const keys = Array.from(activeTouches.keys());
            const loserKey = keys[Math.floor(Math.random() * keys.length)];
            const loser = activeTouches.get(loserKey);

            playSound('boom');
            if(navigator.vibrate) navigator.vibrate([500, 100, 500, 100, 1000]); // 당첨 시 강렬한 진동 패턴
            document.body.classList.add('shake');
            
            // 화면 덮는 폭발 이펙트 생성
            createExplosion(loser.x, loser.y, loser.color);

            setTimeout(() => { document.body.classList.remove('shake'); }, 500);
        }

        function resetGame() {
            gameState = 'WAITING';
            activeTouches.clear();
            availableColors = [...colorPalette];
            explosionCircle.active = false;
            particles = [];
            instruction.style.opacity = '1';
            instruction.innerHTML = "PLACE YOUR<br>FINGERS";
            document.body.style.backgroundColor = '#111';
        }

        // --- 렌더링 루프 ---
        function update() {
            frame++;

            if (gameState === 'COUNTDOWN') {
                let elapsed = Date.now() - countdownStart;
                let remaining = 3 - Math.floor(elapsed / 1000); // 3, 2, 1
                
                if (remaining !== lastTick && remaining > 0) {
                    lastTick = remaining;
                    countdownEl.innerText = remaining;
                    countdownEl.style.transform = `scale(1.5)`; // 팝 효과
                    setTimeout(() => countdownEl.style.transform = `scale(1)`, 100);
                    playSound('tick');
                    if(navigator.vibrate) navigator.vibrate(50);
                }

                if (elapsed >= 3000) {
                    triggerResult();
                }
            }

            // 폭발 원형 확산
            if (explosionCircle.active) {
                explosionCircle.radius += (explosionCircle.maxRadius - explosionCircle.radius) * 0.15;
            }

            // 파티클 업데이트
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy;
                p.vy += 0.5; // 중력
                p.alpha -= p.decay;
                if (p.alpha <= 0) particles.splice(i, 1);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // 결과 폭발 시 배경을 덮는 거대한 원
            if (explosionCircle.active) {
                ctx.beginPath();
                ctx.arc(explosionCircle.x, explosionCircle.y, explosionCircle.radius, 0, Math.PI * 2);
                ctx.fillStyle = explosionCircle.color;
                ctx.fill();
            }

            // 각 플레이어의 터치 포인트 그리기
            if (gameState !== 'RESULT') {
                activeTouches.forEach(touch => {
                    touch.pulse += 0.1;
                    
                    // 빛나는 바깥 테두리
                    ctx.beginPath();
                    ctx.arc(touch.x, touch.y, 60 + Math.sin(touch.pulse) * 10, 0, Math.PI * 2);
                    ctx.fillStyle = touch.color + '40'; // 투명도 추가
                    ctx.fill();
                    
                    // 중앙 코어
                    ctx.beginPath();
                    ctx.arc(touch.x, touch.y, 40, 0, Math.PI * 2);
                    ctx.fillStyle = touch.color;
                    ctx.fill();
                    
                    // 테두리 라인
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = '#fff';
                    ctx.stroke();
                });
            }

            // 폭발 파티클
            if (explosionCircle.active) {
                particles.forEach(p => {
                    ctx.globalAlpha = p.alpha;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2);
                    ctx.fillStyle = '#fff'; // 파티클은 튀는 하얀색/혹은 컬러 혼합
                    ctx.fill();
                });
                ctx.globalAlpha = 1.0;
                
                // 결과창 안내 문구 그리기 (캔버스 최상단)
                ctx.fillStyle = '#fff';
                ctx.font = '900 3rem Arial Black';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.shadowBlur = 10;
                ctx.fillText("YOU LOSE!", explosionCircle.x, explosionCircle.y - 100);
                ctx.font = '700 1.2rem Arial';
                ctx.fillText("Tap to reset", explosionCircle.x, explosionCircle.y - 50);
                ctx.shadowBlur = 0; // 그림자 초기화
            }
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        loop();

    </script>
</body>
</html>