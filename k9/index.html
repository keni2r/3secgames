<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Micro Pixel Shooter</title>
    <style>
        /* 2. 비주얼 개편: 그린 터미널 스타일 및 폰트 변경 */
        @font-face {
            font-family: 'PixelFont';
            src: url('https://fonts.cdnfonts.com/s/11511/PressStart2P-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            /* 만약 외부 폰트 로딩이 안되면 기본 monospace 사용 */
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #001100; /* 아주 어두운 녹색 배경 */
            color: #00ff00; /* 형광 녹색 텍스트 */
            font-family: 'PixelFont', 'Courier New', monospace; /* 픽셀 느낌 폰트 */
            overflow: hidden;
            touch-action: none;
        }
        canvas {
            display: block;
            /* 픽셀 그래픽이 흐릿해지지 않게 설정 */
            image-rendering: optimizeSpeed;             /* Older versions of FF          */
            image-rendering: -moz-crisp-edges;          /* FF 6.0+                       */
            image-rendering: -webkit-optimize-contrast; /* Safari                        */
            image-rendering: -o-crisp-edges;            /* OS X & Windows Opera (12.02+) */
            image-rendering: pixelated;                 /* Awesome future-proof property */
            -ms-interpolation-mode: nearest-neighbor;   /* IE                            */
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 17, 0, 0.8); /* 배경을 약간 어둡게 */
        }
        #menu {
            text-align: center;
            pointer-events: auto;
            border: 4px solid #00ff00;
            padding: 30px;
            background-color: #001100;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .stars {
            font-size: 2rem;
            margin-bottom: 30px;
            letter-spacing: 5px;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: inherit;
            background-color: #00ff00;
            color: #001100;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 0 #004400; /* 픽셀 느낌 버튼 그림자 */
        }
        button:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: none;
            justify-content: space-between;
            font-size: 1rem;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="hud">
        <div id="scoreDisplay">SCR: 0</div>
        <div id="weaponDisplay">WPN: LV.1</div>
        <div id="hudStars">☆☆☆</div>
    </div>

    <div id="ui-layer">
        <div id="menu">
            <h1>MICRO PIXEL SHOOTER</h1>
            <div id="menuStars" class="stars">☆☆☆</div>
            <button id="startBtn">INSERT COIN</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const menu = document.getElementById('menu');
        const hud = document.getElementById('hud');
        const startBtn = document.getElementById('startBtn');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const weaponDisplay = document.getElementById('weaponDisplay');
        const menuStars = document.getElementById('menuStars');
        const hudStars = document.getElementById('hudStars');

        let canvasWidth, canvasHeight;

        function resize() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            initBackground(); // 화면 크기 변경 시 배경 재초기화
        }
        window.addEventListener('resize', resize);
        
        // --- 3. 배경 그래픽스 (우주) 설정 ---
        let backgroundStars = [];
        function initBackground() {
            backgroundStars = [];
            for (let i = 0; i < 100; i++) {
                backgroundStars.push({
                    x: Math.random() * canvasWidth,
                    y: Math.random() * canvasHeight,
                    size: Math.random() * 3 + 1, // 픽셀 크기
                    speed: Math.random() * 2 + 0.5
                });
            }
        }

        // --- 무기 정의 (총 9단계) ---
        const weaponDefinitions = [
            { level: 1, name: "Pistol", delay: 400, speed: 8, size: 4, count: 1, spread: 0 },
            { level: 2, name: "Dual", delay: 350, speed: 8, size: 4, count: 2, spread: 10 },
            { level: 3, name: "SMG", delay: 150, speed: 10, size: 3, count: 1, spread: 0 },
            { level: 4, name: "Rifle", delay: 200, speed: 12, size: 4, count: 2, spread: 5 },
            { level: 5, name: "Shotgun", delay: 600, speed: 8, size: 5, count: 3, spread: 20 },
            { level: 6, name: "HMG", delay: 100, speed: 12, size: 4, count: 1, spread: 5, randomSpread: true },
            { level: 7, name: "Grenade", delay: 500, speed: 6, size: 10, count: 1, spread: 0 }, // 폭발 미구현, 그냥 큰 총알
            { level: 8, name: "Minigun", delay: 80, speed: 14, size: 4, count: 5, spread: 25 },
            { level: 9, name: "Bazooka", delay: 800, speed: 5, size: 16, count: 1, spread: 0 }
        ];

        let gameState = 'MENU';
        let score = 0;
        let frameCount = 0;
        
        // 플레이어 설정
        const player = {
            x: 0, y: 0, width: 32, height: 32,
            color: '#00ff00',
            lastShootTime: 0,
            weaponLevel: 1 // 현재 무기 레벨
        };

        let bullets = [];
        let enemies = [];
        let items = []; // 1. 무기 업그레이드 아이템 배열

        function movePlayer(x, y) {
            if (gameState !== 'PLAYING') return;
            // 픽셀 단위로 움직이는 느낌을 주기 위해 좌표 반올림
            player.x = Math.round(Math.max(player.width/2, Math.min(canvasWidth - player.width/2, x)));
            player.y = Math.round(Math.max(player.height/2, Math.min(canvasHeight - player.height/2, y)));
        }

        window.addEventListener('mousemove', (e) => movePlayer(e.clientX, e.clientY));
        window.addEventListener('touchmove', (e) => { e.preventDefault(); movePlayer(e.touches[0].clientX, e.touches[0].clientY); }, { passive: false });
        startBtn.addEventListener('click', startGame);

        function startGame() {
            gameState = 'PLAYING';
            score = 0;
            frameCount = 0;
            bullets = [];
            enemies = [];
            items = [];
            player.weaponLevel = 1; // 게임 시작 시 무기 레벨 초기화
            player.x = canvasWidth / 2;
            player.y = canvasHeight - 100;
            
            document.getElementById('ui-layer').style.display = 'none';
            hud.style.display = 'flex';
            updateHUD();
            gameLoop();
        }

        function updateHUD() {
            scoreDisplay.innerText = `SCR: ${score}`;
            weaponDisplay.innerText = `WPN: ${weaponDefinitions[player.weaponLevel-1].name}`;
            let starsStr = '☆☆☆';
            if (score >= 5000) starsStr = '★★★';
            else if (score >= 3000) starsStr = '★★☆';
            else if (score >= 1000) starsStr = '★☆☆';
            hudStars.innerText = starsStr;
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            hud.style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            let finalStars = '☆☆☆';
            if (score >= 5000) finalStars = '★★★';
            else if (score >= 3000) finalStars = '★★☆';
            else if (score >= 1000) finalStars = '★☆☆';
            
            menuStars.innerText = finalStars;
            startBtn.innerText = 'RETRY';
        }

        // 무기 업그레이드 함수
        function upgradeWeapon() {
            if (player.weaponLevel < 9) {
                player.weaponLevel++;
                // 업그레이드 효과음이나 시각 효과 추가 가능
                console.log("Weapon Upgraded to Lv." + player.weaponLevel);
                updateHUD();
            }
        }

        // --- 그리기 함수 (모두 픽셀/사각형 스타일) ---
        function drawRectEntity(e) {
             // 중앙 기준 좌표를 좌상단 기준 좌표로 변환하여 그리기
            ctx.fillRect(Math.round(e.x - e.size/2), Math.round(e.y - e.size/2), e.size, e.size);
        }

        function draw() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            // 배경 별 그리기
            ctx.fillStyle = '#004400'; // 어두운 녹색 별
            backgroundStars.forEach(star => {
                ctx.fillRect(Math.round(star.x), Math.round(star.y), star.size, star.size);
            });

            // 플레이어 그리기 (픽셀 우주선 느낌)
            ctx.fillStyle = player.color;
            // 본체
            ctx.fillRect(player.x - 8, player.y - 8, 16, 16);
            // 날개
            ctx.fillRect(player.x - 16, player.y, 8, 8);
            ctx.fillRect(player.x + 8, player.y, 8, 8);
            // 기수
            ctx.fillRect(player.x - 4, player.y - 16, 8, 8);

            // 총알 그리기
            ctx.fillStyle = '#aaff00'; // 밝은 연두색
            bullets.forEach(b => drawRectEntity(b));

            // 적 그리기
            ctx.fillStyle = '#00cc00'; // 적 녹색
            enemies.forEach(e => {
                // 적 본체
                drawRectEntity(e);
                 // 적 눈 (픽셀 느낌 더하기)
                 ctx.fillStyle = '#001100';
                 ctx.fillRect(e.x - 4, e.y - 2, 2, 2);
                 ctx.fillRect(e.x + 2, e.y - 2, 2, 2);
                 ctx.fillStyle = '#00cc00'; // 다시 적 색상으로 복구
            });

             // 아이템 그리기
             items.forEach(item => {
                ctx.fillStyle = (frameCount % 20 < 10) ? '#ffffff' : '#00ff00'; // 깜빡임 효과
                ctx.fillRect(item.x - item.size/2, item.y - item.size/2, item.size, item.size);
                // 아이템 내부에 텍스트 표시
                ctx.fillStyle = '#001100';
                ctx.font = '12px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(item.type, item.x, item.y);
            });
        }

        function update() {
            frameCount++;
            const now = Date.now();
            const weapon = weaponDefinitions[player.weaponLevel - 1];

            // 1. 배경 업데이트 (스크롤)
            backgroundStars.forEach(star => {
                star.y += star.speed;
                if (star.y > canvasHeight) {
                    star.y = -star.size;
                    star.x = Math.random() * canvasWidth;
                }
            });

            // 2. 플레이어 발사 로직 (무기 정의 기반)
            if (now - player.lastShootTime > weapon.delay) {
                let startAngle = -weapon.spread * (weapon.count - 1) / 2;
                for (let i = 0; i < weapon.count; i++) {
                    let angle = startAngle + weapon.spread * i;
                    if (weapon.randomSpread) angle += (Math.random() - 0.5) * weapon.spread;
                    
                    let rad = angle * Math.PI / 180;
                    bullets.push({
                        x: player.x,
                        y: player.y - player.height/2,
                        size: weapon.size,
                        speedX: Math.sin(rad) * weapon.speed,
                        speedY: -Math.cos(rad) * weapon.speed
                    });
                }
                player.lastShootTime = now;
            }

            // 3. 총알 이동
            bullets.forEach(b => {
                b.x += b.speedX;
                b.y += b.speedY;
            });
            bullets = bullets.filter(b => b.y > -20 && b.y < canvasHeight + 20 && b.x > -20 && b.x < canvasWidth + 20);

            // 4. 적 생성
            if (frameCount % 40 === 0) {
                enemies.push({
                    x: Math.random() * (canvasWidth - 32) + 16,
                    y: -32,
                    size: 24, // 사각형 한 변의 길이
                    speed: 2 + Math.random() * 2
                });
            }

            // 5. 아이템 생성 (적보다 드물게 생성)
            if (frameCount % 300 === 0 && player.weaponLevel < 9) { // 약 5초마다, 만렙 아닐때만
                items.push({
                    x: Math.random() * (canvasWidth - 32) + 16,
                    y: -32,
                    size: 24,
                    speed: 2,
                    type: 'U' // Upgrade
                });
            }

            // 6. 적 이동 및 충돌 체크
            for (let i = enemies.length - 1; i >= 0; i--) {
                let enemy = enemies[i];
                enemy.y += enemy.speed;
                if (enemy.y > canvasHeight + 20) { enemies.splice(i, 1); continue; }

                // 사각형 충돌 감지 (AABB)
                let playerHit = 
                    player.x - player.width/2 < enemy.x + enemy.size/2 &&
                    player.x + player.width/2 > enemy.x - enemy.size/2 &&
                    player.y - player.height/2 < enemy.y + enemy.size/2 &&
                    player.y + player.height/2 > enemy.y - enemy.size/2;

                if (playerHit) gameOver();

                for (let j = bullets.length - 1; j >= 0; j--) {
                    let bullet = bullets[j];
                     // 사각형 충돌 감지
                    if (bullet.x - bullet.size/2 < enemy.x + enemy.size/2 &&
                        bullet.x + bullet.size/2 > enemy.x - enemy.size/2 &&
                        bullet.y - bullet.size/2 < enemy.y + enemy.size/2 &&
                        bullet.y + bullet.size/2 > enemy.y - enemy.size/2) {
                        bullets.splice(j, 1);
                        enemies.splice(i, 1);
                        score += 5;
                        updateHUD();
                        break; // 적 하나에 총알 하나만 맞음
                    }
                }
            }

            // 7. 아이템 이동 및 획득 체크
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += item.speed;
                if (item.y > canvasHeight + 20) { items.splice(i, 1); continue; }

                // 플레이어와 아이템 충돌 체크
                let itemHit = 
                    player.x - player.width/2 < item.x + item.size/2 &&
                    player.x + player.width/2 > item.x - item.size/2 &&
                    player.y - player.height/2 < item.y + item.size/2 &&
                    player.y + player.height/2 > item.y - item.size/2;

                if (itemHit) {
                    items.splice(i, 1);
                    upgradeWeapon();
                }
            }
        }

        function gameLoop() {
            if (gameState !== 'PLAYING') return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // 초기화 및 폰트 로딩 대기 (임시 방편)
        resize();
        draw(); // 초기 화면 그리기
        setTimeout(() => { resize(); draw(); }, 500); // 폰트 로딩 후 재조정

    </script>
</body>
</html>