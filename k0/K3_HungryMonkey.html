<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>8-bit Monkey Jump</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #0f380f; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Press Start 2P', cursive; /* 픽셀 폰트 적용 */
            user-select: none;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 400px;
        }
        canvas { 
            display: block; 
            background: #9bbc0f; 
            margin: auto;
            border: 4px solid #306230;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(155, 188, 15, 0.5);
        }
        #uiLayer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #0f380f;
            text-align: center;
            pointer-events: none; 
        }
        h1 { font-size: 24px; line-height: 1.5; margin-bottom: 20px; text-shadow: 2px 2px #8bac0f; }
        p { font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        
        .btn {
            pointer-events: auto;
            background: #0f380f;
            color: #9bbc0f;
            border: 4px solid #306230;
            padding: 15px 20px;
            margin: 10px;
            font-size: 14px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); background: #306230; }
        #gameOverUI { display: none; }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="uiLayer">
        <div id="startUI">
            <h1>MONKEY<br>JUMP</h1>
            <p>- TAP TO GO -</p>
        </div>
        <div id="gameOverUI">
            <h1>GAME OVER</h1>
            <p id="finalScoreText">SCORE: 0</p>
            <button class="btn" onclick="restartGame()">RESTART</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startUI = document.getElementById('startUI');
    const gameOverUI = document.getElementById('gameOverUI');
    const finalScoreText = document.getElementById('finalScoreText');

    canvas.width = window.innerWidth > 400 ? 400 : window.innerWidth;
    canvas.height = 600;

    const C_DARK = '#0f380f';
    const C_MID_DARK = '#306230';
    const C_MID_LIGHT = '#8bac0f';
    const C_LIGHT = '#9bbc0f';

    // 1. 원숭이 달리기 애니메이션 (다리 벌림)
    const monkeyRun1 = [
        [0,0,2,2,2,2,0,0],
        [0,2,1,1,1,1,2,0],
        [2,1,2,1,1,2,1,2],
        [2,1,2,1,1,2,1,2],
        [0,2,1,1,1,1,2,0],
        [0,0,2,2,2,2,0,0],
        [0,2,1,1,1,1,2,0],
        [2,2,0,0,0,0,2,2]
    ];

    // 2. 원숭이 달리기 애니메이션 (다리 모음)
    const monkeyRun2 = [
        [0,0,2,2,2,2,0,0],
        [0,2,1,1,1,1,2,0],
        [2,1,2,1,1,2,1,2],
        [2,1,2,1,1,2,1,2],
        [0,2,1,1,1,1,2,0],
        [0,0,2,2,2,2,0,0],
        [0,2,1,1,1,1,2,0],
        [0,2,2,0,0,2,2,0]
    ];

    // 3. 원숭이 점프 애니메이션 (다리 접음)
    const monkeyJump = [
        [0,0,2,2,2,2,0,0],
        [0,2,1,1,1,1,2,0],
        [2,1,2,1,1,2,1,2],
        [2,1,2,1,1,2,1,2],
        [0,2,1,1,1,1,2,0],
        [0,0,2,2,2,2,0,0],
        [2,2,1,1,1,1,2,2],
        [0,0,0,0,0,0,0,0]
    ];

    // 구름 스프라이트 (3번은 하늘색/연두색)
    const cloudSprite = [
        [0,0,0,0,3,3,3,3,0,0,0,0],
        [0,0,3,3,3,3,3,3,3,3,0,0],
        [0,3,3,3,3,3,3,3,3,3,3,0],
        [3,3,3,3,3,3,3,3,3,3,3,3]
    ];

    const bigBananaSprite = [
        [0,0,0,0,0,2,2,0,0,0],
        [0,0,0,0,2,1,1,2,0,0],
        [0,0,0,2,1,1,2,0,0,0],
        [0,0,2,1,1,2,0,0,0,0],
        [0,2,1,1,2,0,0,0,0,0],
        [0,2,1,1,2,0,0,0,0,0],
        [0,2,1,1,2,0,0,0,0,0],
        [0,0,2,1,1,2,0,0,0,0],
        [0,0,0,2,2,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0]
    ];

    const onionSprite = [
        [0,0,0,1,1,0,0,0],
        [0,0,1,2,2,1,0,0],
        [0,1,2,1,1,2,1,0],
        [1,2,1,1,1,1,2,1],
        [1,2,1,1,1,1,2,1],
        [1,2,2,1,1,2,2,1],
        [0,1,2,2,2,2,1,0],
        [0,0,1,1,1,1,0,0]
    ];

    let state = 'START'; 
    let score = 0;
    let frames = 0;
    let level = 0; 
    
    const pixelSize = 5; 
    const groundY = canvas.height - 100;
    
    let player = { 
        x: canvas.width / 2 - (4 * pixelSize), 
        y: groundY, 
        w: 8 * pixelSize, 
        h: 8 * pixelSize, 
        vy: 0, 
        jumpCount: 0 
    };
    
    let items = [];
    let particles = [];
    
    // 구름 배열 (위치, 속도, 크기 다양화)
    let clouds = [
        { x: 50, y: 80, speed: 0.3 },
        { x: 250, y: 150, speed: 0.5 },
        { x: 400, y: 60, speed: 0.2 }
    ];

    function drawSprite(sprite, x, y) {
        for (let r = 0; r < sprite.length; r++) {
            for (let c = 0; c < sprite[r].length; c++) {
                if (sprite[r][c] === 1) ctx.fillStyle = C_MID_DARK;
                else if (sprite[r][c] === 2) ctx.fillStyle = C_DARK;
                else if (sprite[r][c] === 3) ctx.fillStyle = C_MID_LIGHT; // 구름 색상
                else continue;
                ctx.fillRect(x + c * pixelSize, y + r * pixelSize, pixelSize, pixelSize);
            }
        }
    }

    function update() {
        if (state !== 'PLAYING') return;
        frames++;

        if (frames % 600 === 0 && level < 3) level++;

        // 구름 이동 (천천히 흘러감)
        clouds.forEach(cloud => {
            cloud.x -= cloud.speed;
            if (cloud.x + (12 * pixelSize) < 0) {
                cloud.x = canvas.width;
                cloud.y = 40 + Math.random() * 150; // 랜덤 높이 재배치
            }
        });

        // 플레이어 중력 및 바닥 충돌
        player.vy += 0.5;
        player.y += player.vy;

        if (player.y >= groundY) {
            player.y = groundY;
            player.vy = 0;
            player.jumpCount = 0; 
        }

        let baseSpeed = 4 * Math.pow(1.25, level);
        
        // 아이템 스폰
        if (frames % 60 === 0) {
            let spawnCount = 1;
            if (level === 0) {
                let isHigh = (Math.floor(frames / 60) % 2 === 0);
                spawnItem(isHigh ? groundY - 200 : groundY - 40, baseSpeed, 0);
            } else {
                if (level === 1) spawnCount = Math.floor(Math.random() * 2) + 2; 
                else if (level === 2) spawnCount = Math.floor(Math.random() * 3) + 3; 
                else if (level === 3) spawnCount = Math.floor(Math.random() * 4) + 4; 

                for (let i = 0; i < spawnCount; i++) {
                    let randomY = 30 + Math.random() * (groundY - 70);
                    let offsetX = i * 40; 
                    spawnItem(randomY, baseSpeed, offsetX);
                }
            }
        }

        // 아이템 로직
        for (let i = items.length - 1; i >= 0; i--) {
            let item = items[i];
            item.x -= item.speed;

            if (player.x < item.x + item.w && player.x + player.w > item.x &&
                player.y < item.y + item.h && player.y + player.h > item.y) {
                
                if (item.type === 'onion') {
                    gameOver();
                    return;
                } else {
                    score += item.points;
                    particles.push({ text: '+5', x: item.x, y: item.y, life: 30 });
                    items.splice(i, 1);
                    continue;
                }
            }

            if (item.x + item.w < 0) {
                items.splice(i, 1);
                continue;
            }
        }

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].y -= 1;
            particles[i].life--;
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
    }

    function spawnItem(y, speed, offsetX) {
        let onionProb = 0.15 + (level * 0.05); 
        if (Math.random() < onionProb) {
            items.push({ type: 'onion', x: canvas.width + offsetX, y: y, w: 8 * pixelSize, h: 8 * pixelSize, speed: speed });
        } else {
            items.push({ type: 'banana', x: canvas.width + offsetX, y: y, w: 10 * pixelSize, h: 10 * pixelSize, speed: speed, points: 5 });
        }
    }

    function draw() {
        // 배경 그리기
        ctx.fillStyle = C_LIGHT;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 구름 그리기 (플레이어/아이템보다 뒤에 위치)
        clouds.forEach(cloud => {
            drawSprite(cloudSprite, cloud.x, cloud.y);
        });
        
        // 바닥 그리기
        ctx.fillStyle = C_DARK;
        ctx.fillRect(0, groundY + player.h, canvas.width, 4);

        if (state === 'PLAYING' || state === 'GAMEOVER') {
            
            // 플레이어 애니메이션 결정 로직
            let currentMonkeySprite;
            if (player.y < groundY) {
                currentMonkeySprite = monkeyJump; // 공중에 있을 때는 다리 접음
            } else {
                // 바닥에 있을 때는 10프레임마다 다리를 교차하며 달림
                currentMonkeySprite = (frames % 20 < 10) ? monkeyRun1 : monkeyRun2;
            }
            
            drawSprite(currentMonkeySprite, player.x, player.y);

            // 아이템 그리기
            items.forEach(item => {
                let sprite = item.type === 'onion' ? onionSprite : bigBananaSprite;
                drawSprite(sprite, item.x, item.y);
            });

            // 팝업 텍스트 그리기 (픽셀 폰트 적용)
            ctx.font = "12px 'Press Start 2P', cursive";
            particles.forEach(p => {
                ctx.fillStyle = p.life % 10 > 5 ? C_DARK : C_MID_DARK;
                ctx.fillText(p.text, p.x, p.y);
            });

            // 캔버스 상단 스코어 UI (픽셀 폰트 적용)
            ctx.fillStyle = C_DARK;
            ctx.font = "14px 'Press Start 2P', cursive";
            ctx.fillText(`SCORE:${score}`, 15, 30);
            ctx.fillText(`LV:${level + 1}`, canvas.width - 80, 30);
        }
    }

    function jump() {
        if (state === 'START') {
            state = 'PLAYING';
            startUI.style.display = 'none';
        } else if (state === 'PLAYING' && player.jumpCount < 3) {
            player.vy = -11.5; 
            player.jumpCount++;
        }
    }

    function gameOver() {
        state = 'GAMEOVER';
        finalScoreText.innerText = `SCORE: ${score}`;
        gameOverUI.style.display = 'block';
    }

    window.restartGame = function() {
        player.y = groundY;
        player.vy = 0;
        player.jumpCount = 0;
        items = [];
        particles = [];
        score = 0;
        frames = 0;
        level = 0;
        state = 'PLAYING';
        gameOverUI.style.display = 'none';
    };

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    // 폰트가 로딩된 후 캔버스에 그리기 위해 문서 로드 완료 시 루프 시작
    document.fonts.ready.then(() => {
        loop();
    });

    canvas.addEventListener('mousedown', jump);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); }, {passive: false});

</script>
</body>
</html>